# Руководство по производительности сервера

## Текущие результаты тестирования

**Конфигурация:** 1 CPU, 1 GB RAM
**Тест:** 30 RPS в течение 10 секунд

### Оценка производительности

На основе ваших результатов тестирования (30 RPS):

#### Текущая конфигурация (1 CPU, 1 GB RAM):
- **Стабильная нагрузка:** ~24 RPS (80% от пиковой)
- **Пиковая нагрузка:** ~30 RPS
- **Рекомендация:** Сервер работает на пределе возможностей

#### Планируемая конфигурация (2 CPU, 2 GB RAM):
- **Стабильная нагрузка:** ~60 RPS (прогноз: ~2.5x улучшение)
- **Пиковая нагрузка:** ~75 RPS
- **Улучшение производительности:** ~2.5x

## Детальная оценка производительности

### Факторы, влияющие на производительность:

1. **CPU (процессор):**
   - Node.js однопоточный, но может использовать worker threads
   - PostgreSQL эффективно использует несколько ядер
   - 2 CPU дадут ~1.8-2x улучшение для БД запросов

2. **RAM (память):**
   - Node.js приложение: ~100-200 MB
   - PostgreSQL: минимум 256 MB, оптимально 512 MB - 1 GB
   - Система и кэши: ~200-300 MB
   - С 1 GB RAM: критически мало, возможен swap
   - С 2 GB RAM: достаточно для комфортной работы

3. **I/O (диск и сеть):**
   - SSD значительно быстрее HDD
   - Сетевое соединение влияет на внешние запросы

### Расчет реальной производительности:

**Формула оценки:**
```
Новая производительность = Текущая × (CPU_улучшение) × (RAM_коэффициент)
```

Где:
- CPU_улучшение = 1.8-2.0x (для Node.js + PostgreSQL)
- RAM_коэффициент = 1.2-1.3x (устранение swap)

**Итого:** ~2.2-2.6x улучшение = **~2.5x в среднем**

## Практические рекомендации

### Для конфигурации 1 CPU, 1 GB RAM:

✅ **Что делать:**
- Мониторить использование RAM (не должно превышать 90%)
- Использовать swap файл (минимум 1 GB)
- Оптимизировать запросы к БД (индексы, кэширование)
- Ограничить одновременные соединения
- Использовать CDN для статики

❌ **Что не делать:**
- Не запускать дополнительные сервисы
- Не увеличивать пул соединений БД свыше 10-15
- Не включать verbose логирование

### Для конфигурации 2 CPU, 2 GB RAM:

✅ **Рекомендации:**
- Увеличить пул соединений PostgreSQL до 20-30
- Включить кэширование запросов
- Использовать Redis для сессий (опционально)
- Настроить worker threads для Node.js (если нужно)
- Оптимизировать PostgreSQL (shared_buffers = 512 MB)

## Оптимизация производительности

### 1. Настройка PostgreSQL (postgresql.conf):

```conf
# Для 2 GB RAM
shared_buffers = 512MB          # 25% от RAM
effective_cache_size = 1536MB   # 75% от RAM
work_mem = 10MB                 # Для сортировок
maintenance_work_mem = 128MB    # Для обслуживания
max_connections = 100           # Зависит от нагрузки
```

### 2. Настройка Node.js:

```javascript
// В server/index.js или через переменные окружения
process.env.UV_THREADPOOL_SIZE = '4'; // Для 2 CPU
```

### 3. Мониторинг производительности:

**Полезные команды:**

```bash
# Мониторинг CPU и RAM
htop
# или
top

# Мониторинг PostgreSQL
psql -U postgres -c "SELECT * FROM pg_stat_activity;"

# Проверка использования RAM
free -h

# Проверка использования диска
df -h
```

## Ожидаемые результаты после апгрейда

### С 1 CPU, 1 GB RAM → 2 CPU, 2 GB RAM:

| Метрика | До | После | Улучшение |
|---------|-----|-------|-----------|
| Стабильный RPS | ~24 | ~60 | 2.5x |
| Пиковый RPS | ~30 | ~75 | 2.5x |
| Время ответа | ~200-500ms | ~100-200ms | 2x быстрее |
| Одновременные пользователи | ~50-100 | ~150-300 | 3x |

### Примечания:

- Реальные результаты могут варьироваться в зависимости от:
  - Сложности запросов к БД
  - Объема данных в базе
  - Скорости диска (SSD vs HDD)
  - Сетевой задержки
  - Кэширования

## Тестирование после апгрейда

После обновления конфигурации выполните:

```bash
# Постепенное увеличение нагрузки
RPS=50 DURATION=30 npm run load-test
RPS=75 DURATION=30 npm run load-test
RPS=100 DURATION=30 npm run load-test
```

Это поможет определить реальные возможности нового сервера.

## Заключение

**Текущая конфигурация (1 CPU, 1 GB RAM):**
- Подходит для небольших проектов
- Максимум ~30-40 RPS
- Возможны проблемы при пиковых нагрузках

**Рекомендуемая конфигурация (2 CPU, 2 GB RAM):**
- Оптимальна для средних проектов
- Ожидается ~60-75 RPS стабильно
- Запас для роста нагрузки
- Улучшение в ~2.5 раза

**Для высоких нагрузок (>100 RPS):**
- Рекомендуется 4 CPU, 4 GB RAM
- Использование Redis для кэширования
- CDN для статики
- Балансировщик нагрузки (nginx/HAProxy)
